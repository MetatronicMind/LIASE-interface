# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy Node.js app to Azure Web App - LIASE-backend

on:
  push:
    branches:
      - dev
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Install dependencies, build, and test
        working-directory: ./backend
        run: |
          npm install
          npm run build --if-present
          npm run test --if-present

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: backend/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app

      - name: Prepare deployment files
        run: |
          pwd
          ls -la
          echo "Contents:"
          find . -name "package.json" -type f
          echo "Moving backend contents to root for deployment..."
          if [ -d "backend" ]; then
            mv backend/* .
            mv backend/.[^.]* . 2>/dev/null || true
            rmdir backend
          fi
          echo "After move:"
          ls -la
          echo "package.json location:"
          find . -name "package.json" -type f

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_C686999406FB464790F64E3C71D31C63 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_9FC45B7FDE2F490D91697B10ACD1CDCE }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_B19280752E554AA892F23221EC6AB45E }}

      - name: 'Deploy to Azure Web App'
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'LIASE-backend'
          slot-name: 'Production'
          package: .
        env:
          # Cosmos DB Configuration
          COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
          COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
          COSMOS_DB_DATABASE_ID: ${{ secrets.COSMOS_DB_DATABASE_ID }}
          # Application Configuration
          NODE_ENV: production
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN: ${{ secrets.JWT_EXPIRES_IN }}

      - name: Health Check
        run: |
          sleep 30
          webapp_url="${{ steps.deploy-to-webapp.outputs.webapp-url }}"
          
          echo "Checking Backend API health at $webapp_url"
          
          max_attempts=5
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Health check attempt $attempt/$max_attempts"
            
            # Test health endpoint (adjust the endpoint as needed)
            if curl -f -s "$webapp_url/health" -o /dev/null || curl -f -s "$webapp_url/api/health" -o /dev/null || curl -f -s "$webapp_url/" -o /dev/null; then
              echo "‚úÖ Backend API is responding successfully at $webapp_url"
              echo "üéâ Backend deployment completed successfully!"
              break
            else
              if [ $attempt -eq $max_attempts ]; then
                echo "‚ùå Backend health check failed after $max_attempts attempts"
                echo "Please check the Azure portal for deployment logs"
                exit 1
              else
                echo "‚è≥ API not ready yet, waiting 30 seconds..."
                sleep 30
                attempt=$((attempt + 1))
              fi
            fi
          done