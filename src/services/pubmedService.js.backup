const fetch = require('node-fetch');
const xml2js = require('xml2js');

class PubMedService {
  constructor() {
    this.base = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils';
  }

  // Simple method to discover drugs from PubMed
  async discoverDrugs(options = {}) {
    const { maxResults = 50 } = options;
    
    try {
      console.log('Starting drug discovery with options:', options);
      
      // Search for drug-related articles
      const drugArticles = await this.getDrugArticles('drug adverse effects OR drug safety OR medication', maxResults);
      
      console.log(`Found ${drugArticles.length} drug articles`);
      
      return {
        totalFound: drugArticles.length,
        drugs: drugArticles,
        searchDate: new Date().toISOString(),
        searchParams: options
      };
    } catch (error) {
      console.error('Error discovering drugs:', error);
      throw new Error(`Drug discovery failed: ${error.message}`);
    }
  }

  // Simple search for drug-related articles
  async getDrugArticles(term = 'drug', maxResults = 50) {
    try {
      console.log(`Searching PubMed for: ${term} (max ${maxResults} results)`);
      
      // 1. Search PubMed for the term
      const searchUrl = `${this.base}/esearch.fcgi?db=pubmed&term=${encodeURIComponent(term)}&retmax=${maxResults}&retmode=json`;
      console.log('Search URL:', searchUrl);
      
      const searchResp = await fetch(searchUrl);
      const searchJson = await searchResp.json();
      
      if (!searchJson.esearchresult || !searchJson.esearchresult.idlist) {
        console.log('No results found');
        return [];
      }
      
      const ids = searchJson.esearchresult.idlist;
      console.log(`Found ${ids.length} PMIDs:`, ids.slice(0, 5), '...');
      
      if (ids.length === 0) {
        return [];
      }

      // 2. Fetch article details with efetch
      const fetchUrl = `${this.base}/efetch.fcgi?db=pubmed&id=${ids.join(',')}&retmode=xml`;
      const fetchResp = await fetch(fetchUrl);
      const xml = await fetchResp.text();

      // 3. Parse the XML response
      const parser = new xml2js.Parser();
      const result = await parser.parseStringPromise(xml);
      
      if (!result.PubmedArticleSet || !result.PubmedArticleSet.PubmedArticle) {
        console.log('No articles in XML response');
        return [];
      }

      // 4. Extract article information
      const articles = result.PubmedArticleSet.PubmedArticle;
      const drugArticles = articles.map((article, index) => {
        try {
          const citation = article.MedlineCitation[0];
          const articleData = citation.Article[0];
          const pmid = citation.PMID[0]._ || citation.PMID[0];
          
          const title = articleData.ArticleTitle[0] || 'No title';
          const abstract = articleData.Abstract ? 
            (articleData.Abstract[0].AbstractText ? 
              (Array.isArray(articleData.Abstract[0].AbstractText) ? 
                articleData.Abstract[0].AbstractText.join(' ') : 
                articleData.Abstract[0].AbstractText) : 
              '') : '';
          
          const authors = articleData.AuthorList ? 
            articleData.AuthorList[0].Author.map(author => {
              const lastName = author.LastName ? author.LastName[0] : '';
              const firstName = author.ForeName ? author.ForeName[0] : '';
              return `${firstName} ${lastName}`.trim();
            }) : [];
          
          const journal = articleData.Journal ? articleData.Journal[0].Title[0] : 'Unknown Journal';
          
          // Extract potential drug names from title and abstract
          const text = `${title} ${abstract}`.toLowerCase();
          const drugName = this.extractDrugName(text, index);
          
          return {
            drugName: drugName,
            pmid: pmid,
            title: title,
            abstract: abstract.substring(0, 500), // Limit abstract length
            authors: authors.slice(0, 5), // Limit authors
            journal: journal,
            publicationDate: this.extractPublicationDate(article),
            relevantText: title.substring(0, 200),
            confidence: 80
          };
        } catch (err) {
          console.error('Error parsing article:', err);
          return null;
        }
      }).filter(Boolean);

      console.log(`Successfully parsed ${drugArticles.length} articles`);
      return drugArticles;
      
    } catch (error) {
      console.error('PubMed API error:', error);
      throw new Error(`Failed to fetch drug articles: ${error.message}`);
    }
  }

  // Simple drug name extraction
  extractDrugName(text, index) {
    // Look for common drug patterns
    const drugPatterns = [
      /(\w+)ine\b/g,  // drugs ending in -ine
      /(\w+)ol\b/g,   // drugs ending in -ol  
      /(\w+)cin\b/g,  // drugs ending in -cin
      /(\w+)pam\b/g,  // drugs ending in -pam
      /(\w+)tine\b/g, // drugs ending in -tine
    ];

    for (const pattern of drugPatterns) {
      const matches = text.match(pattern);
      if (matches) {
        const drugName = matches[0].charAt(0).toUpperCase() + matches[0].slice(1);
        if (drugName.length > 3) {
          return drugName;
        }
      }
    }

    // Fallback to generic name
    return `Drug-${index + 1}`;
  }

  // Extract publication date
  extractPublicationDate(article) {
    try {
      const pubDate = article.MedlineCitation[0].Article[0].Journal[0].JournalIssue[0].PubDate[0];
      if (pubDate.Year) {
        const year = pubDate.Year[0];
        const month = pubDate.Month ? pubDate.Month[0] : '01';
        const day = pubDate.Day ? pubDate.Day[0] : '01';
        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
      }
    } catch (err) {
      // Ignore parsing errors
    }
    return '2024-01-01'; // Default date
  }
}

module.exports = new PubMedService();

    const params = this.buildParams({
      db: 'pubmed',
      id: pmids.join(','),
      retmode: 'xml'
    });
    const url = `${this.base}/efetch.fcgi`;
    const { data: xml } = await axios.get(url, { params });
    const parsed = await parseStringPromise(xml, { explicitArray: false, mergeAttrs: true });

    const articles =
      parsed?.PubmedArticleSet?.PubmedArticle || [];
    const list = Array.isArray(articles) ? articles : [articles];

    return list.filter(Boolean).map(a => this.mapArticle(a));
  }

  mapArticle(a) {
    try {
      const art = a?.MedlineCitation?.Article || {};
      const journal = art?.Journal?.Title || '';
      const pubDateNode = art?.Journal?.JournalIssue?.PubDate || {};
      const year = pubDateNode?.Year || pubDateNode?.MedlineDate || '';
      const publicationDate = typeof year === 'string' ? `${year}-01-01` : new Date().toISOString();
      const title = (art?.ArticleTitle || '').toString();

      const abstractNode = art?.Abstract;
      let abstract = '';
      if (abstractNode?.AbstractText) {
        if (Array.isArray(abstractNode.AbstractText)) {
          abstract = abstractNode.AbstractText.map(t => (typeof t === 'string' ? t : t._ || '')).join('\n');
        } else {
          abstract = (abstractNode.AbstractText._ || abstractNode.AbstractText || '').toString();
        }
      }

      const pmid = a?.MedlineCitation?.PMID || a?.PubmedData?.ArticleIdList?.ArticleId;

      let authors = [];
      const authorList = art?.AuthorList?.Author;
      if (authorList) {
        const arr = Array.isArray(authorList) ? authorList : [authorList];
        authors = arr.map(x => {
          const last = x?.LastName || '';
          const fore = x?.ForeName || x?.Initials || '';
          return `${fore} ${last}`.trim();
        }).filter(Boolean);
      }

      return {
        pmid: Array.isArray(pmid) ? pmid[0] : pmid?.toString?.() || '',
        title,
        journal,
        publicationDate,
        abstract,
        authors
      };
    } catch (e) {
      return null;
    }
  }

  // Search for drug-related articles and extract drug names with PMIDs
  async searchDrugArticles(options = {}) {
    const { 
      includeAdverseEvents = true, 
      includeSafety = true, 
      includeToxicity = false,
      maxResults = 100,
      dateFrom,
      dateTo 
    } = options;

    console.log('searchDrugArticles called with options:', options);

    // Build broad drug search query
    const drugTerms = [
      'drug[tiab]', 'medication[tiab]', 'pharmaceutical[tiab]', 
      'medicine[tiab]', 'therapeutic[tiab]', 'treatment[tiab]'
    ];
    
    // Add safety-related terms
    const safetyTerms = [];
    if (includeAdverseEvents) {
      safetyTerms.push('"adverse event"[tiab]', '"adverse events"[tiab]', '"side effect"[tiab]', '"side effects"[tiab]');
    }
    if (includeSafety) {
      safetyTerms.push('"safety"[tiab]', '"drug safety"[tiab]');
    }
    if (includeToxicity) {
      safetyTerms.push('"toxicity"[tiab]', '"toxic"[tiab]');
    }

    const drugQuery = `(${drugTerms.join(' OR ')})`;
    const safetyQuery = safetyTerms.length ? ` AND (${safetyTerms.join(' OR ')})` : '';
    const finalQuery = drugQuery + safetyQuery;

    console.log('PubMed search query:', finalQuery);
    console.log('Search parameters:', { maxResults, dateFrom, dateTo });

    try {
      const pmids = await this.search(finalQuery, { maxResults, dateFrom, dateTo });
      console.log('PMIDs found:', pmids.length);
      
      if (pmids.length === 0) {
        console.log('No PMIDs found, returning empty array');
        return [];
      }

      // Fetch details to extract drug names
      console.log('Fetching details for PMIDs...');
      const articles = await this.fetchDetails(pmids);
      console.log('Articles fetched:', articles.length);
      
      // Extract drug names from articles
      console.log('Extracting drugs from articles...');
      const extractedDrugs = this.extractDrugsFromArticles(articles);
      console.log('Drugs extracted:', extractedDrugs.length);
      
      return extractedDrugs;
    } catch (error) {
      console.error('Error in searchDrugArticles:', error);
      throw error;
    }
  }

  // Search for specific drug by name
  async searchDrugs(drugName, options = {}) {
    const { 
      includeAdverseEvents = true, 
      includeSafety = true, 
      includeToxicity = false,
      maxResults = 50,
      dateFrom,
      dateTo 
    } = options;

    // Build drug-specific query
    let queryParts = [`"${drugName}"[tiab]`, `"${drugName}"[tw]`];
    
    // Add safety-related terms
    const safetyTerms = [];
    if (includeAdverseEvents) {
      safetyTerms.push('"adverse event"[tiab]', '"adverse events"[tiab]', '"side effect"[tiab]', '"side effects"[tiab]');
    }
    if (includeSafety) {
      safetyTerms.push('"safety"[tiab]', '"drug safety"[tiab]');
    }
    if (includeToxicity) {
      safetyTerms.push('"toxicity"[tiab]', '"toxic"[tiab]');
    }

    const drugQuery = `(${queryParts.join(' OR ')})`;
    const safetyQuery = safetyTerms.length ? ` AND (${safetyTerms.join(' OR ')})` : '';
    const finalQuery = drugQuery + safetyQuery;

    return this.search(finalQuery, { maxResults, dateFrom, dateTo });
  }

  async searchDrugInfo(drugName, options = {}) {
    const { maxResults = 20 } = options;
    
    // Search for general drug information
    const query = `("${drugName}"[tiab] OR "${drugName}"[tw]) AND (pharmacology[tiab] OR mechanism[tiab] OR indication[tiab] OR therapeutic[tiab])`;
    
    return this.search(query, { maxResults });
  }

  async getDrugSummary(drugName, options = {}) {
    try {
      // Get both safety data and general info
      const [safetyIds, infoIds] = await Promise.all([
        this.searchDrugs(drugName, { maxResults: 20, ...options }),
        this.searchDrugInfo(drugName, { maxResults: 10 })
      ]);

      // Combine and deduplicate IDs
      const allIds = [...new Set([...safetyIds, ...infoIds])];
      
      if (allIds.length === 0) {
        return {
          drugName,
          articles: [],
          summary: {
            totalArticles: 0,
            safetyArticles: safetyIds.length,
            infoArticles: infoIds.length
          }
        };
      }

      // Fetch detailed articles
      const articles = await this.fetchDetails(allIds.slice(0, 30)); // Limit to 30 for performance

      return {
        drugName,
        articles,
        summary: {
          totalArticles: articles.length,
          safetyArticles: safetyIds.length,
          infoArticles: infoIds.length,
          query: `Safety articles for ${drugName}`
        }
      };
    } catch (error) {
      console.error(`Error getting drug summary for ${drugName}:`, error);
      throw error;
    }
  }

  // Extract drug names from articles using pattern matching
  extractDrugsFromArticles(articles) {
    const drugPattern = /\b([A-Z][a-z]+(?:in|ol|ide|ine|ate|ant|ase|ast|ent|ic|al|um|an|or))\b/g;
    const commonDrugs = new Set([
      'Aspirin', 'Ibuprofen', 'Acetaminophen', 'Metformin', 'Lisinopril', 'Simvastatin',
      'Omeprazole', 'Amlodipine', 'Metoprolol', 'Hydrochlorothiazide', 'Atorvastatin',
      'Levothyroxine', 'Albuterol', 'Furosemide', 'Prednisone', 'Tramadol', 'Gabapentin',
      'Amoxicillin', 'Ciprofloxacin', 'Warfarin', 'Insulin', 'Morphine', 'Codeine',
      'Digoxin', 'Propranolol', 'Losartan', 'Citalopram', 'Sertraline', 'Fluoxetine',
      'Lorazepam', 'Alprazolam', 'Diazepam', 'Oxycodone', 'Fentanyl', 'Clonazepam'
    ]);

    const extractedDrugs = [];
    const seenDrugs = new Set();

    articles.forEach(article => {
      const textToSearch = `${article.title} ${article.abstract}`.toLowerCase();
      
      // Look for known drug names (case-insensitive)
      commonDrugs.forEach(drug => {
        const drugLower = drug.toLowerCase();
        if (textToSearch.includes(drugLower) && !seenDrugs.has(drugLower)) {
          seenDrugs.add(drugLower);
          extractedDrugs.push({
            drugName: drug,
            pmid: article.pmid,
            title: article.title,
            journal: article.journal,
            publicationDate: article.publicationDate,
            relevantText: this.extractRelevantText(textToSearch, drugLower),
            confidence: this.calculateDrugConfidence(textToSearch, drugLower)
          });
        }
      });

      // Also try pattern matching for potential drug names
      const matches = article.title.match(drugPattern) || [];
      const abstractMatches = article.abstract.match(drugPattern) || [];
      const allMatches = [...matches, ...abstractMatches];

      allMatches.forEach(match => {
        const drugLower = match.toLowerCase();
        if (!seenDrugs.has(drugLower) && match.length > 4) { // Filter out short matches
          seenDrugs.add(drugLower);
          extractedDrugs.push({
            drugName: match,
            pmid: article.pmid,
            title: article.title,
            journal: article.journal,
            publicationDate: article.publicationDate,
            relevantText: this.extractRelevantText(`${article.title} ${article.abstract}`, drugLower),
            confidence: this.calculateDrugConfidence(textToSearch, drugLower),
            isPatternMatch: true
          });
        }
      });
    });

    // Sort by confidence and return top results
    return extractedDrugs
      .sort((a, b) => b.confidence - a.confidence)
      .slice(0, 50); // Limit results
  }

  extractRelevantText(text, drugName) {
    const index = text.toLowerCase().indexOf(drugName);
    if (index === -1) return '';
    
    const start = Math.max(0, index - 100);
    const end = Math.min(text.length, index + drugName.length + 100);
    
    return text.substring(start, end).trim();
  }

  calculateDrugConfidence(text, drugName) {
    let confidence = 0;
    
    // Base confidence for finding the drug name
    confidence += 10;
    
    // Boost confidence for safety-related keywords
    const safetyKeywords = ['adverse', 'side effect', 'toxicity', 'safety', 'reaction', 'allergy'];
    safetyKeywords.forEach(keyword => {
      if (text.includes(keyword)) confidence += 5;
    });
    
    // Boost confidence for clinical keywords
    const clinicalKeywords = ['clinical', 'trial', 'study', 'patient', 'treatment', 'therapy'];
    clinicalKeywords.forEach(keyword => {
      if (text.includes(keyword)) confidence += 3;
    });
    
    // Penalize very common words that might be false positives
    const commonWords = ['the', 'and', 'for', 'with', 'from', 'this', 'that'];
    if (commonWords.includes(drugName.toLowerCase())) confidence -= 20;
    
    return Math.max(0, confidence);
  }

  // Get drug discovery results with PMIDs
  async discoverDrugs(options = {}) {
    const { maxResults = 50, dateFrom, dateTo } = options;
    
    try {
      console.log('Starting drug discovery with options:', options);
      
      const drugArticles = await this.searchDrugArticles({
        maxResults,
        dateFrom,
        dateTo,
        includeAdverseEvents: true,
        includeSafety: true
      });

      console.log('Drug articles found:', drugArticles.length);
      
      // Check if no drugs were found
      if (!drugArticles || drugArticles.length === 0) {
        console.log('No drug articles found, returning empty result');
        return {
          totalFound: 0,
          drugs: [],
          searchDate: new Date().toISOString(),
          searchParams: options
        };
      }
      
      const result = {
        totalFound: drugArticles.length,
        drugs: drugArticles,
        searchDate: new Date().toISOString(),
        searchParams: options
      };
      
      console.log('Returning discovery result:', {
        totalFound: result.totalFound,
        searchParams: result.searchParams
      });
      
      return result;
    } catch (error) {
      console.error('Error discovering drugs:', error);
      throw new Error(`Drug discovery failed: ${error.message}`);
    }
  }

  // Generate PubMed query string for a drug
  generateDrugQuery(drugName, options = {}) {
    const { 
      includeAdverseEvents = true, 
      includeSafety = true, 
      includeToxicity = false 
    } = options;

    let queryParts = [`"${drugName}"[tiab]`];
    
    const safetyTerms = [];
    if (includeAdverseEvents) {
      safetyTerms.push('"adverse event"[tiab]', '"side effect"[tiab]');
    }
    if (includeSafety) {
      safetyTerms.push('"safety"[tiab]');
    }
    if (includeToxicity) {
      safetyTerms.push('"toxicity"[tiab]');
    }

    const drugQuery = queryParts.join(' OR ');
    const safetyQuery = safetyTerms.length ? ` AND (${safetyTerms.join(' OR ')})` : '';
    
    return `(${drugQuery})${safetyQuery}`;
  }
}

module.exports = new PubMedService();
